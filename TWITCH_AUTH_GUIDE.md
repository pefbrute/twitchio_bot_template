# Подробное руководство по настройке аутентификации Twitch OAuth для вашего бота

Это руководство поможет вам шаг за шагом получить все необходимые токены для вашего Twitch-бота, чтобы он мог подключаться к чату, отправлять сообщения и выполнять модераторские действия. Процесс включает регистрацию приложения на Twitch, получение Client ID и Client Secret, а затем обмен кода авторизации на Access Token и Refresh Token.

## Содержание
1.  [Что такое OAuth и зачем это нужно?](#1-что-такое-oauth-и-зачем-это-нужно)
2.  [Предварительные требования](#2-предварительные-требования)
3.  [Шаг 1: Регистрация приложения на Twitch Developer Portal](#3-шаг-1-регистрация-приложения-на-twitch-developer-portal)
    *   [Получение Client ID и Client Secret](#получение-client-id-и-client-secret)
4.  [Шаг 2: Определение необходимых прав (Scopes)](#4-шаг-2-определение-необходимых-прав-scopes)
5.  [Шаг 3: Подготовка к авторизации](#5-шаг-3-подготовка-к-авторизации)
6.  [Шаг 4: Формирование URL для авторизации](#6-шаг-4-формирование-url-для-авторизации)
7.  [Шаг 5: Авторизация приложения и получение кода](#7-шаг-5-авторизация-приложения-и-получение-кода)
8.  [Шаг 6: Обмен кода авторизации на токены (Access Token и Refresh Token)](#8-шаг-6-обмен-кода-авторизации-на-токены-access-token-и-refresh-token)
    *   [Использование `curl` для обмена кода на токены](#использование-curl-для-обмена-кода-на-токены)
9.  [Шаг 7: Хранение токенов и других данных](#9-шаг-7-хранение-токенов-и-других-данных)
10. [Шаг 8: Валидация Access Token (Рекомендуется)](#10-шаг-8-валидация-access-token-рекомендуется)
11. [Шаг 9: Обновление Access Token с помощью Refresh Token](#11-шаг-9-обновление-access-token-с-помощью-refresh-token)
12. [Заключение](#12-заключение)

## 1. Что такое OAuth и зачем это нужно?

OAuth 2.0 — это стандартный протокол авторизации, который позволяет приложениям (например, вашему боту) получать доступ к ресурсам пользователя на другом сервисе (в данном случае, Twitch) без необходимости знать логин и пароль пользователя. Вместо этого используются **токены доступа (Access Tokens)**.

*   **Access Token**: Используется для аутентификации API-запросов к Twitch от имени пользователя (бота). Он имеет ограниченный срок действия.
*   **Refresh Token**: Используется для получения нового Access Token, когда старый истекает, без необходимости повторной авторизации пользователем.

Эти токены, вместе с **Client ID** и **Client Secret** вашего приложения, являются ключами к взаимодействию вашего бота с Twitch API.

## 2. Предварительные требования

*   **Аккаунт Twitch для бота**: Это отдельный аккаунт Twitch, который будет использоваться вашим ботом. **Не используйте свой основной аккаунт Twitch для бота.**
*   **Аккаунт Twitch для канала**: Канал, который бот будет модерировать или с которым будет взаимодействовать.

## 3. Шаг 1: Регистрация приложения на Twitch Developer Portal

Чтобы ваш бот мог взаимодействовать с Twitch API, его нужно зарегистрировать как приложение.

1.  Перейдите на [Twitch Developer Console](https://dev.twitch.tv/console/apps).
2.  Войдите в систему, используя свой **основной аккаунт Twitch** (или аккаунт разработчика). На этом этапе **не используйте аккаунт бота**.
3.  Нажмите на кнопку **"+ Register Your Application"** (Зарегистрировать ваше приложение).
4.  Заполните форму:
    *   **Name** (Название): Придумайте любое название для вашего приложения (например, "SuperModBot"). **ВАЖНО**: Не используйте слово "Twitch" в названии.
    *   **OAuth Redirect URLs** (URL-адреса перенаправления OAuth): Введите `http://localhost:3000`. Этот URL используется в процессе авторизации. Даже если у вас нет запущенного сервера по этому адресу, он необходим для получения кода авторизации.
    *   **Category** (Категория): Выберите "Chat Bot" (Чат-бот).
5.  Нажмите кнопку **"Create"** (Создать).

### Получение Client ID и Client Secret

После создания приложения вы увидите ваш **Client ID**. Скопируйте и сохраните его в надежном месте.

Чтобы получить **Client Secret**:
1.  На странице вашего приложения нажмите кнопку **"New Secret"** (Новый секрет).
2.  Twitch сгенерирует и покажет вам **Client Secret**. **ВАЖНО**: Client Secret отображается только один раз. Немедленно скопируйте его и сохраните в очень надежном месте вместе с Client ID. Если вы его потеряете, придется генерировать новый.

Эти Client ID и Client Secret будут использоваться для аутентификации вашего приложения (бота) при запросах к Twitch API.

## 4. Шаг 2: Определение необходимых прав (Scopes)

Scopes (области действия, права) определяют, какие действия ваш бот сможет выполнять от имени пользователя (бота). Для типичного модераторского бота могут потребоваться следующие scopes:

*   `chat:read` - Чтение сообщений чата.
*   `chat:edit` - Отправка сообщений в чат (и удаление сообщений через команду `/delete`).
*   `channel:moderate` - Использование модераторских команд (например, `/timeout`, `/ban`).
*   `moderator:manage:chat_messages` - Позволяет удалять сообщения напрямую через API (если вы планируете использовать этот метод).
*   `moderator:manage:banned_users` - Управление забаненными пользователями.
*   `moderator:read:followers` - Чтение списка фолловеров (если боту это нужно).
*   `whispers:read` - Чтение личных сообщений.
*   `whispers:edit` - Отправка личных сообщений.
*   `user:manage:whispers` - Управление личными сообщениями.

Полный список scopes и их описание можно найти в [документации Twitch](https://dev.twitch.tv/docs/authentication/scopes/).

Для примера, строка scopes может выглядеть так:
`chat:read+chat:edit+channel:moderate+moderator:manage:chat_messages+moderator:manage:banned_users+moderator:read:followers`
(Разделитель `+` используется при формировании URL, или пробел, если указываете в другом контексте).

## 5. Шаг 3: Подготовка к авторизации

1.  **Выйдите из своего основного аккаунта Twitch** во всех вкладках вашего браузера. Это важно, чтобы случайно не авторизовать приложение от имени вашего основного аккаунта.
2.  **Войдите в аккаунт Twitch, который будет использовать бот** (аккаунт бота).
3.  **(Рекомендуется)** Сделайте аккаунт бота модератором на вашем основном канале. Это расширит его возможности (например, увеличит лимиты на отправку сообщений и позволит выполнять команды модерации). Для этого в чате вашего основного канала введите команду:
    `/mod ИМЯ_АККАУНТА_БОТА`
    Замените `ИМЯ_АККАУНТА_БОТА` на реальное имя пользователя вашего бота.

## 6. Шаг 4: Формирование URL для авторизации

Теперь нужно сформировать специальный URL, который вы откроете в браузере (где залогинен аккаунт бота) для авторизации вашего приложения.

Структура URL:
`https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=ВАШ_CLIENT_ID&redirect_uri=http://localhost:3000&scope=ВАШИ_SCOPES&force_verify=true`

Замените:
*   `ВАШ_CLIENT_ID`: На ваш Client ID, полученный на Шаге 1.
*   `ВАШИ_SCOPES`: На строку scopes, определенную на Шаге 2 (например, `chat:read+chat:edit+channel:moderate`). Убедитесь, что scopes разделены знаком `+`.

Пример готового URL:
`https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=abcdef1234567890&redirect_uri=http://localhost:3000&scope=chat:read+chat:edit+channel:moderate&force_verify=true`

Параметр `force_verify=true` запрашивает явное подтверждение авторизации, даже если пользователь ранее уже давал разрешение.

## 7. Шаг 5: Авторизация приложения и получение кода

1.  Скопируйте сформированный на Шаге 4 URL.
2.  Вставьте его в адресную строку браузера, в котором вы **авторизованы под аккаунтом бота**. Нажмите Enter.
3.  Twitch запросит у вас разрешение на доступ вашего приложения к данным в соответствии с указанными scopes. Внимательно проверьте запрашиваемые права и нажмите кнопку **"Authorize"** (Авторизовать).
4.  После успешной авторизации браузер перенаправит вас на указанный `redirect_uri` (`http://localhost:3000`). Так как у вас, скорее всего, нет веб-сервера, слушающего этот адрес, вы увидите ошибку типа "This site can't be reached" или "Не удается получить доступ к сайту". **Это нормально и ожидаемо!**
5.  **Самое важное**: Посмотрите на адресную строку браузера. URL будет выглядеть примерно так:
    `http://localhost:3000/?code=ДЛИННЫЙ_КОД_АВТОРИЗАЦИИ&scope=запрошенные_scopes`
6.  Скопируйте значение параметра `code` из этого URL. Это **код авторизации (Authorization Code)**. Он одноразовый и действителен короткое время.

Пример: если URL `http://localhost:3000/?code=zyxw9876543210&scope=chat:read+chat:edit`, то ваш код авторизации — `zyxw9876543210`.

## 8. Шаг 6: Обмен кода авторизации на токены (Access Token и Refresh Token)

Полученный код авторизации необходимо обменять на Access Token и Refresh Token. Этот обмен происходит путем отправки POST-запроса на сервер Twitch. **Этот запрос должен включать ваш Client Secret, поэтому его нельзя делать из клиентского JavaScript в браузере.**

### Использование `curl` для обмена кода на токены

`curl` — это мощная утилита командной строки для выполнения HTTP-запросов. Она доступна на большинстве операционных систем (Linux, macOS, Windows).

Откройте терминал или командную строку и выполните следующую команду, подставив свои значения:

```bash
curl -X POST "https://id.twitch.tv/oauth2/token" \
-H "Content-Type: application/x-www-form-urlencoded" \
-d "client_id=ВАШ_CLIENT_ID" \
-d "client_secret=ВАШ_CLIENT_SECRET" \
-d "code=КОД_АВТОРИЗАЦИИ" \
-d "grant_type=authorization_code" \
-d "redirect_uri=http://localhost:3000"
```

Замените:
*   `ВАШ_CLIENT_ID`: Ваш Client ID.
*   `ВАШ_CLIENT_SECRET`: Ваш Client Secret.
*   `КОД_АВТОРИЗАЦИИ`: Код авторизации, полученный на Шаге 5.

**Пример ответа от сервера Twitch (в формате JSON):**

```json
{
  "access_token": "НОВЫЙ_ACCESS_TOKEN",
  "refresh_token": "НОВЫЙ_REFRESH_TOKEN",
  "expires_in": 14058,
  "scope": [
    "chat:read",
    "chat:edit",
    "channel:moderate"
  ],
  "token_type": "bearer"
}
```

Из этого ответа вам нужны:
*   `access_token`: Ваш Access Token.
*   `refresh_token`: Ваш Refresh Token.

Скопируйте и сохраните их в очень надежном месте. `expires_in` показывает время жизни Access Token в секундах.

Если вы не хотите использовать `curl`, вы можете использовать другие инструменты для API-запросов, такие как Postman или Insomnia, настроив POST-запрос с указанными параметрами.

## 9. Шаг 7: Хранение токенов и других данных

Теперь у вас есть все необходимые учетные данные для вашего бота:
*   `CLIENT_ID`
*   `CLIENT_SECRET`
*   `ACCESS_TOKEN`
*   `REFRESH_TOKEN`
*   `BOT_USERNAME` (имя пользователя аккаунта бота)
*   `CHANNEL_NAME` (имя канала, где будет работать бот)

Крайне важно хранить эти данные безопасно, особенно `CLIENT_SECRET`, `ACCESS_TOKEN` и `REFRESH_TOKEN`.

**Рекомендуемые способы хранения:**
*   **Переменные окружения (Environment Variables)**: Это наиболее безопасный способ.
*   **Файл `.env`**: Создайте файл с именем `.env` в корневом каталоге вашего проекта и добавьте в него строки вида `КЛЮЧ=ЗНАЧЕНИЕ`. Обязательно добавьте `.env` в ваш `.gitignore`, чтобы случайно не загрузить его в репозиторий.

Пример содержимого файла `.env`:
```
BOT_USERNAME=имя_вашего_бота
CHANNEL_NAME=имя_вашего_канала
CLIENT_ID=ваш_client_id
CLIENT_SECRET=ваш_client_secret
ACCESS_TOKEN=ваш_access_token
REFRESH_TOKEN=ваш_refresh_token
```

## 10. Шаг 8: Валидация Access Token (Рекомендуется)

Чтобы убедиться, что ваш Access Token действителен и принадлежит нужному пользователю (боту), вы можете выполнить запрос валидации.

**Запрос (GET):**
URL: `https://id.twitch.tv/oauth2/validate`
Headers: `Authorization: Bearer ВАШ_ACCESS_TOKEN`

**С помощью `curl`:**
```bash
curl -X GET "https://id.twitch.tv/oauth2/validate" \
-H "Authorization: Bearer ВАШ_ACCESS_TOKEN"
```
Замените `ВАШ_ACCESS_TOKEN` на полученный Access Token.

**Пример успешного ответа (JSON):**
```json
{
  "client_id": "ваш_client_id",
  "login": "имя_вашего_бота",
  "scopes": ["chat:read", "chat:edit"],
  "user_id": "id_пользователя_бота",
  "expires_in": 13900 // Оставшееся время жизни токена в секундах
}
```
Убедитесь, что `login` соответствует имени пользователя вашего бота, а `client_id` — вашему Client ID.

## 11. Шаг 9: Обновление Access Token с помощью Refresh Token

Access Token имеет ограниченный срок действия (обычно несколько часов). Когда он истекает, ваш бот потеряет доступ к API. Чтобы этого избежать, используйте Refresh Token для получения нового Access Token.

**Запрос (POST):**
URL: `https://id.twitch.tv/oauth2/token`
Body (x-www-form-urlencoded):
*   `grant_type`: `refresh_token`
*   `refresh_token`: ВАШ_REFRESH_TOKEN
*   `client_id`: ВАШ_CLIENT_ID
*   `client_secret`: ВАШ_CLIENT_SECRET

**С помощью `curl`:**
```bash
curl -X POST "https://id.twitch.tv/oauth2/token" \
-H "Content-Type: application/x-www-form-urlencoded" \
-d "grant_type=refresh_token" \
-d "refresh_token=ВАШ_REFRESH_TOKEN" \
-d "client_id=ВАШ_CLIENT_ID" \
-d "client_secret=ВАШ_CLIENT_SECRET"
```
Замените `ВАШ_REFRESH_TOKEN`, `ВАШ_CLIENT_ID`, `ВАШ_CLIENT_SECRET` на ваши значения.

**Ответ сервера:**
Сервер вернет новый `access_token` и, возможно, новый `refresh_token`. **Всегда сохраняйте новый `refresh_token`, если он предоставлен, так как старый может стать недействительным.**

```json
{
  "access_token": "САМЫЙ_НОВЫЙ_ACCESS_TOKEN",
  "refresh_token": "ВОЗМОЖНО_НОВЫЙ_REFRESH_TOKEN",
  "scope": ["chat:read", "chat:edit"],
  "token_type": "bearer",
  "expires_in": 14400
}
```
Обновите сохраненные `ACCESS_TOKEN` и `REFRESH_TOKEN` новыми значениями. Ваш бот должен автоматически выполнять эту процедуру до истечения срока действия Access Token.

## 12. Заключение

Поздравляем! Вы успешно прошли все шаги для получения OAuth токенов Twitch. Теперь ваш бот готов к работе. Помните о безопасном хранении ваших учетных данных и регулярном обновлении Access Token. 