# Документация модуля Steal

## Общее описание
Модуль `steal` реализует функционал кражи виртуальной валюты между пользователями в чате Twitch. Система включает в себя механизмы шансов кражи, кулдауны, штрафы за неудачные попытки и специальные условия для новых пользователей.

## Структура модуля

### 1. `__init__.py`
Основной файл инициализации модуля, экспортирующий основные классы и функции:
- `StealChanceCommands`
- `steal_chance_manager`
- `StealCommand`
- `try_steal`

### 2. `command.py`
Содержит основной класс `StealCommand`, который реализует команду кражи (`!украсть`).

#### Основные функции:
- Обработка команды кражи
- Определение цели кражи через:
  - Ответ на сообщение (reply)
  - Упоминание (@username)
  - Случайный выбор из активных пользователей
- Проверка валидности цели
- Выдача стартового баланса (100 рублей) новым пользователям
- Форматирование и отправка разнообразных сообщений об успехе/неудаче

### 3. `steal_logic.py`
Содержит основную логику процесса кражи в функции `try_steal()`.

#### Ключевые особенности:
- Базовый шанс кражи: 40%
- Для пользователей с нулевым балансом: 20%
- Привилегированные пользователи получают +20% к шансу
- Максимальная сумма кражи: 30% от баланса жертвы
- Штраф при неудаче: случайная сумма до 30% от баланса вора
- При успешной краже с нулевым балансом: фиксированная награда 1 рубль

### 4. `steal_chance_manager.py`
Менеджер для управления индивидуальными шансами кражи и защиты от кражи.

#### Основной функционал:
- Хранение индивидуальных шансов в JSON файлах
- Управление шансами кражи для отдельных пользователей
- Управление шансами защиты от кражи
- Приоритезация шансов: шанс жертвы > шанс вора > базовый шанс
- Реализация паттерна Singleton для единого доступа к данным

### 5. `steal_chance_commands.py`
Реализует команды модерации для управления шансами.

#### Доступные команды:
- `!шанс-кражи @username [chance]` - установка/просмотр шанса кражи
- `!шанс-жертвы @username [chance]` - установка/просмотр шанса защиты

Команды доступны только модераторам и специально указанным пользователям.

## Процесс кражи

1. **Инициация кражи**:
   - Пользователь вводит команду `!украсть`
   - Цель определяется через reply, @mention или случайный выбор

2. **Проверки**:
   - Валидность цели
   - Наличие денег у цели
   - Кулдауны (60 секунд для пользователя, 10 секунд глобальный)
   - Проверка на кражу у бота или у себя

3. **Определение шанса**:
   - Проверка индивидуального шанса защиты цели
   - Проверка индивидуального шанса кражи вора
   - Применение базового шанса если индивидуальные не установлены
   - Модификация шанса для привилегированных пользователей

4. **Результат**:
   - **Успех**: Вор получает случайную сумму до 30% баланса жертвы
   - **Неудача**: Вор теряет случайную сумму до 30% своего баланса в пользу жертвы
   - **Особый случай**: Пользователи с нулевым балансом могут украсть только 1 рубль
   - **Кража у бота**: Автоматическая потеря всех денег

## Интеграция с другими модулями

- Использует `balance_manager` для операций с балансами
- Использует `cooldown_manager` для управления задержками
- Интегрируется с системой привилегий и модерации
- Использует фильтр имен пользователей для безопасности

## Примечания по безопасности

- Защита от самокражи
- Фильтрация небезопасных имен пользователей
- Специальная обработка попыток кражи у бота
- Сохранение всех транзакций в логах
- Проверка валидности входных данных при установке шансов